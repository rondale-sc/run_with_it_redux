<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>Omniauth and Other Drugs</title>

  <!-- Twitter Bootstrap -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css" />

  <!-- My Custom CSS -->
  <link rel="stylesheet" href="/css/custom.css" type="text/css" />

  <link href="/images/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon">

  <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25565068-1']);
  _gaq.push(['_setDomainName', 'jonathan-jackson.net']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>

<body>
  <div id="header">
    <h1>run<span class="kern">_</span>with_it <span style="font-size:12px;">Learning, sharing, coding.</span></h1>
    <div class="row">
      <div class="span1 offset8"><a href="/" alt="home">Home</a></div>
      <div class="span1"><a href="/about-me.html" alt="about-me">About Me</a></div>
      <div class="span2"><a href="/mail.html" alt="contact-me">Contact Me</a></div>
    </div>
  </div>

  <div class="container">
    <div id="content">
     <div id="post">
<h1>Omniauth and Other Drugs</h1>

<p><span><a href="http://twitter.com/share" class="twitter-share-button"
                                         data-count="horizontal"
                                         data-via="rondale_sc">Tweet</a>
</span></p>

<p>First of all I'd like to apologize for my extended absence these last few months.  I have been extremely busy revamping three old rails apps, one of which was using rails ~1.2.</p>

<p>Anyways, that's not what I want to talk about today.  Today is all about Omniauth.  I originally chalked Omniauth up as yet another flavor of the week authentication mechanism.  Boy was I wrong.  Omniauth is an authentication framework that allows you to incorporate standardized 'Strategies' quickly in your applications.  It's a Rack middleware so including it into Rails/Sinatra/whatever is incredibly easy and even fun.  Here I'm going to show you a trick that our team used to create a default provider login in a rails application using Omniauth's #on_failed_registration hook.</p>

<p>Surprise Code!</p>

<p><script src='https://gist.github.com/2156513.js?file=gist-1.rb'></script><noscript></p>

<pre lang="sh"><code>#config/initializers/omniauth.rb
provider :LDAP,
         :host =&gt; '0.0.0.0',
         :port =&gt; 389,
         :method =&gt; :plain,
         :base =&gt; 'dc=example,dc=com',
         :uid =&gt; 'samaccountname',
         :bind_dn =&gt; 'Authorized User',
         :password =&gt; 'Password',
         :name_proc =&gt; Proc.new {|name| name.gsub(/@.*$/,'') }

provider :identity

</code></pre>

<p></noscript></p>

<p>Weird combiniation of authorization mechanisms I know, but it will be illustrative. This is what a typical omniauth initializer looks like.  You specify which providers you want to be available and the necessary information required by the strategy.  Most of the strategies available have good documentation, with the possible exception of LDAP ( though it has enough to start ). Once we realized we wanted to have a single custom form (the default forms are kinda bland) that didn't require the specifying of a provider we started tinkering.</p>

<p><script src='https://gist.github.com/2156513.js?file=gist-2.rb'></script><noscript></p>

<pre lang="sh"><code># First we abstract the parameters of the LDAP
# strategy for use in our callback.

provider :LDAP,
         ldap_parameters = {  :host =&gt; '0.0.0.0',
                              :port =&gt; 389,
                              :method =&gt; :plain,
                              :base =&gt; 'dc=example,dc=com',
                              :uid =&gt; 'samaccountname',
                              :bind_dn =&gt; 'Authorized User',
                              :password =&gt; 'Password',
                              :name_proc   =&gt; Proc.new {|name| name.gsub(/@.*$/,'') }
                            }
provider :identity

#----- Focus on this code! ------------------------------------

on_failure do |env|
  # Set up variables in case LDAP fails.
  # this is the ugliest part of all of this.
  # especially the strategy gsub (Yuck)
  message_key = env['omniauth.error.type']
  strategy    = env['omniauth.error.strategy'].class.name.gsub('OmniAuth::Strategies::','')
  new_path    = &quot;#{OmniAuth.config.path_prefix}/failure?provider=#{strategy}&amp;message=#{message_key}&quot;

  # If they failed to authenticate with default strategy. Use LDAP strategy.
  if env['omniauth.error.strategy'].class == OmniAuth::Strategies::Identity
    ldap_provider = OmniAuth::Strategies::LDAP.new( @app, ldap_parameters)
    env['rack.request.form_hash']['username'] = env['rack.request.form_hash']['auth_key']
    ldap_provider.instance_variable_set(:@env, env)
    ldap_provider.callback_call # run LDAP strategy
  else
    [302, {'Location' =&gt; new_path, 'Content-Type'=&gt; 'text/html'}, []]
  end
end

</code></pre>

<p></noscript></p>

<p>As you can see it's actually quite trivial to have it call another authentication strategy. You have to set the environment, and in this case the username to be authenticated.  Once that's done simply call calback_call which performs the steps necessary to run the callback phase of a strategy.</p>

<p>Now that you understand what is going on let me explain our use case.  We have an application that is accessible to clients via the web (for reporting and the like), but is also an important part of our employee's daily workflow.  We wanted to use this to allow the same form to be used for both people logging in from Identity (clients) and from LDAP (employees).</p>

<p>This accomplished that but felt hackish, so we ended up creating our own oauth strategy/provider.  Still I really like how easy Omniauth made this.  Hope this was interesting.</p>

<h4>References</h4>

<p><span  style="font-size:12px;">1.) <a href="https://github.com/intridea/omniauth">Omniauth</a></span></p>

<h4>Additional References</h4>

<p><span style="font-size:12px;"><a href="http://railscasts.com/episodes/235-omniauth-part-1">Railscasts Omniauth</a></span></p>

<span><a href="http://twitter.com/share" class="twitter-share-button"
                                         data-count="horizontal"
                                         data-via="rondale_sc">Tweet</a>
</span> <span class="has_js"><g:plusone size="medium"></g:plusone></span>
<!-- Place this render call where appropriate -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>


<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'run-with-it';
    var disqus_identifier = '/omniauth-and-other-drugs';
    var disqus_url = 'http://www.jonathan-jackson.net/omniauth-and-other-drugs';
    var disqus_developer = 1;

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
    </div>

    <div id="side-bar">
     <div><a href="http://feeds.feedburner.com/jonathan-jackson/WZqA" title="Subscribe to my feed" rel="alternate" type="application/rss+xml"><img src="/images/feeds.png" alt="" style="border:0;width:100px;height:100px;"/></a></div>
<div><a href="https://twitter.com/rondale_sc" class="twitter-follow-button" alt="follow me on twitter" data-width="150px" data-show-count="false">Follow @rondale_sc</a></div>
<div><img src="/images/gravatar.png" width="167px;" height="167px;"/></div>
<div>
  <h3>Hi, I'm Jon.</h3>
  <p>I love learning new things.  Here is where I'll share what I learn.  Typically code, sometimes my experience, sometimes just a neat trick.</p>
</div>
<div>
  <h3>Projects</h3>
  <ul>
    <li><a href="https://github.com/rondale-sc/EspnRb" alt="espn_rb, a lightweight ruby wrapper around the ESPN api." title="EspnRb">EspnRb</a></li>
    <li><a href="https://github.com/rondale-sc/image_viewer" alt="ImageViewer image browser w/controls" title="Image Viewer">ImageViewer</a></li>
    <li><a href="https://github.com/rondale-sc/run_with_it_redux" alt="This blog's Github Repo" title="Run With It Repo">Run With It</a></li>
  </ul>
</div>
    </div>
  </div>

  <div id="footer">
    <p>Site designed by Jonathan Jackson.  With help from <a href="http://twitter.github.com/bootstrap/" alt="twitter bootstrap">@twbootstrap</a>, <a href="https://github.com/mojombo/jekyll" alt="jekyll">Jekyll</a>, and <a href="https://github.com/" alt="github">github</a></p>
  </div>
</body>
</html>